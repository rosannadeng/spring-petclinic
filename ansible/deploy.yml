---
- name: Deploy Spring PetClinic to Production
  hosts: production
  become: yes
  vars:
    app_name: spring-petclinic
    app_port: 8080
    jar_file: spring-petclinic-*.jar
    deploy_dir: /opt/petclinic

  tasks:
    - name: Create deployment directory
      file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: '0755'
        owner: ubuntu
        group: ubuntu

    - name: Find JAR file in workspace
      find:
        paths: "{{ lookup('env', 'WORKSPACE') }}/target"
        patterns: "{{ jar_file }}"
      register: jar_files
      delegate_to: localhost

    - name: Copy JAR file to production
      copy:
        src: "{{ jar_files.files[0].path }}"
        dest: "{{ deploy_dir }}/app.jar"
        mode: '0755'
        owner: ubuntu
        group: ubuntu

    - name: Stop existing application
      shell: pkill -f 'java.*app.jar' || true
      ignore_errors: yes

    - name: Wait for port to be released
      wait_for:
        port: "{{ app_port }}"
        state: stopped
        timeout: 30
      ignore_errors: yes

    - name: Start application
      shell: |
        cd {{ deploy_dir }}
        nohup java -jar app.jar --server.port={{ app_port }} > app.log 2>&1 &
        sleep 5
      async: 60
      poll: 0

    - name: Wait for application to start
      wait_for:
        port: "{{ app_port }}"
        delay: 10
        timeout: 120

    - name: Verify application health
      uri:
        url: "http://localhost:{{ app_port }}"
        status_code: 200
      register: health_check
      retries: 10
      delay: 5
      until: health_check.status == 200
