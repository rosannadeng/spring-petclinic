---
- name: Deploy Spring PetClinic to Production
  hosts: production
  vars:
    app_name: spring-petclinic
    app_port: 9090
    jar_file: spring-petclinic-*.jar
    deploy_dir: /tmp/petclinic-prod
    app_user: "{{ ansible_user_id }}"

  tasks:
    - name: Create deployment directory
      file:
        path: "{{ deploy_dir }}"
        state: directory
        mode: '0755'

    - name: Find JAR file in target directory
      find:
        paths: "{{ playbook_dir }}/../target"
        patterns: "{{ jar_file }}"
      register: jar_files

    - name: Copy JAR file to production server
      copy:
        src: "{{ jar_files.files[0].path }}"
        dest: "{{ deploy_dir }}/app.jar"
        mode: '0644'

    - name: Check if PetClinic is already running
      shell: "pgrep -f '{{ deploy_dir }}/app.jar' || true"
      register: app_running
      changed_when: false

    - name: Stop existing PetClinic process
      shell: "pkill -f '{{ deploy_dir }}/app.jar' || true"
      when: app_running.stdout != ""

    - name: Wait for port to be released
      wait_for:
        port: "{{ app_port }}"
        state: stopped
        timeout: 30
      when: app_running.stdout != ""
      ignore_errors: yes

    - name: Start PetClinic application
      shell: "nohup java -jar {{ deploy_dir }}/app.jar --server.port={{ app_port }} > {{ deploy_dir }}/app.log 2>&1 &"
      async: 10
      poll: 0

    - name: Wait for application to start
      wait_for:
        port: "{{ app_port }}"
        delay: 5
        timeout: 60

    - name: Verify application is running
      uri:
        url: "http://localhost:{{ app_port }}"
        status_code: 200
      register: result
      retries: 5
      delay: 3
      until: result.status == 200

